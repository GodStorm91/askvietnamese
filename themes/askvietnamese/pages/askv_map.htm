title = "askv_map"
url = "/askv_map"
layout = ""
description = "askvietnamese_map"
is_hidden = 0
robot_index = "index"
robot_follow = "follow"

[GoogleMapsEmbed]
m = "1V0UDdprHNaFYBaN5exvCCyMPwkLPd_F3"
mapType = "roadmap"
width = 100%
height = 450
responsive = 0
==
<!--{% component 'GoogleMapsEmbed' %}-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://s3.amazonaws.com/stitch-sdks/js/bundles/4.0.8/stitch.js"></script>
<style>
    /* Always set the map height explicitly to define the size of the div
    * element that contains the map. */
    #map {
        height: 100%;
    }
    /* Optional: Makes the sample page fill the window. */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }
    /*Cookie Consent Begin*/
    #nudge {
        background-color: rgba(20,20,20,0.8);
        min-height: 26px;
        font-size: 14px;
        color: #ccc;
        line-height: 26px;
        padding: 8px 0 8px 30px;
        font-family: "Trebuchet MS",Helvetica,sans-serif;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: none;
        z-index: 9999;
    }
    #nudge a {
        color: #4B8EE7;
        text-decoration: none;
    }
    #closenudge {
        float: right;
        display: inline-block;
        cursor: pointer;
        height: 20px;
        width: 20px;
        margin: -15px 0 0 0;
        font-weight: bold;
    }
    #closenudge:hover {
        color: #FFF;
    }
    #nudge a.nudgeOK {
        background-color: #F1D600;
        color: #000;
        display: inline-block;
        border-radius: 5px;
        padding: 0 20px;
        cursor: pointer;
        float: right;
        margin: 0 60px 0 10px;
    }
    #nudge a.nudgeOK:hover {
        background-color: #E0C91F;
    }
    /*Cookie Consent End*/
</style>
<div id="map" style="position: relative; overflow: hidden;">
</div>
<div id="nudge">
    <div id="closeNudge">x</div>
    Would you like AskVietnamese shows you your current location on our Map?  <a href="#" target="_blank">More info</a>. <a id="button" class="nudgeOK">That's Fine</a>
</div>
<script>
    var markers = [];
    var info_windows = [];
    var iconBase = "https://s3-ap-southeast-1.amazonaws.com/www.askvietnamese.vn/map_icons/";
    var icons = {
        "Touristic Attractions" : iconBase + "attractions.png",
        "Local's choice - Food Places": iconBase + "local.png",
        "Nice Viewpoints" :iconBase + "feature_place.png",
        "Restaurant and Coffee shops": iconBase + "restaurant.png",
        "Important contacts": iconBase + "local.png",
        "Entertainment": iconBase + "feature_place.png",
    }
    const feature_names = ["Entertainment", "Touristic Attractions", "Local's choice - Food Places", "Important contacts", "Nice Viewpoints", "Restaurant and Coffee shops"]
    const client = stitch.Stitch.initializeDefaultAppClient('askvietnamese-slyvu');

    const db = client.getServiceClient(stitch.RemoteMongoClient.factory, 'mongodb-atlas').db('askvietnamese');

    function getMarkers(callback){
        client.auth.loginWithCredential(new stitch.AnonymousCredential()).then(
            // user =>
            // db.collection('feature_places').updateOne({owner_id: client.auth.user.id}, {$set:{number:42}}, {upsert:true})
            ).then(() =>
            db.collection('feature_places').find().asArray()
            ).then(docs => {
                console.log("Found docs", docs);
                callback(docs);
                console.log("[MongoDB Stitch] Connected to Stitch")
            }).catch(err => {
                console.error(err)
            });
        }

        function setMarkers(map, docs){
            for (var i = 0; i < docs.length; i++){
                // if (docs[i].name == feature_names[0]){
                    for (var j = 0; j < docs[i].features.length; j++){
                        var featured_position = docs[i].features[j];
                        var lat = featured_position.geometry.coordinates[1];
                        var lon = featured_position.geometry.coordinates[0];
                        var contentString = '<div id="content">'+
                        '<div id="siteNotice">'+
                        '</div>'+
                        '<h1 id="firstHeading" class="firstHeading">'+ featured_position.properties.Name  + '</h1>'+
                        '<div id="bodyContent">'+
                        featured_position.properties.description +
                        '</div>'+
                        '</div>';
                        var info_window = new google.maps.InfoWindow({
                            content: contentString,

                        });
                        var icon = {
                            url: icons[docs[i].name],
                            scaledSize: new google.maps.Size(35,50),
                            origin : new google.maps.Point(0,0),
                            anchor : new google.maps.Point(0,0)
                        }
                        var marker = new google.maps.Marker({
                            position: { lat: lat, lng: lon},
                            title: featured_position.properties.Name,
                            icon: icon,
                            map: map
                        });

                        markers.push(marker);
                        info_windows.push(info_window);
                        markers.forEach(function(ele, idx){
                            ele.addListener("click", function(e){
                                info_windows.forEach(function(info_win){
                                    info_win.close();
                                })
                                info_windows[idx].open(map, ele);
                            })
                        })
                    }
                // }
            }
        }
    </script>
    <script type="application/javascript">
        var map;
        function initMap() {
            var styledMapType = new google.maps.StyledMapType(
                [
                {
                    "elementType": "geometry",
                    "stylers": [
                    {
                        "color": "#ebe3cd"
                    }
                    ]
                },
                {
                    "elementType": "labels.text.fill",
                    "stylers": [
                    {
                        "color": "#523735"
                    }
                    ]
                },
                {
                    "elementType": "labels.text.stroke",
                    "stylers": [
                    {
                        "color": "#f5f1e6"
                    }
                    ]
                },
                {
                    "featureType": "administrative",
                    "elementType": "geometry.stroke",
                    "stylers": [
                    {
                        "color": "#c9b2a6"
                    }
                    ]
                },
                {
                    "featureType": "administrative.land_parcel",
                    "elementType": "geometry.stroke",
                    "stylers": [
                    {
                        "color": "#dcd2be"
                    }
                    ]
                },
                {
                    "featureType": "administrative.land_parcel",
                    "elementType": "labels.text.fill",
                    "stylers": [
                    {
                        "color": "#ae9e90"
                    }
                    ]
                },
                {
                    "featureType": "landscape.natural",
                    "elementType": "geometry",
                    "stylers": [
                    {
                        "color": "#dfd2ae"
                    }
                    ]
                },
                {
                    "featureType": "poi",
                    "elementType": "geometry",
                    "stylers": [
                    {
                        "color": "#dfd2ae"
                    }
                    ]
                },
                {
                    "featureType": "poi",
                    "elementType": "labels.text.fill",
                    "stylers": [
                    {
                        "color": "#93817c"
                    }
                    ]
                },
                {
                    "featureType": "poi.attraction",
                    "elementType": "labels.icon",
                    "stylers": [
                    {
                        "weight": 4
                    }
                    ]
                },
                {
                    "featureType": "poi.park",
                    "elementType": "geometry.fill",
                    "stylers": [
                    {
                        "color": "#a5b076"
                    }
                    ]
                },
                {
                    "featureType": "poi.park",
                    "elementType": "labels.text.fill",
                    "stylers": [
                    {
                        "color": "#447530"
                    }
                    ]
                },
                {
                    "featureType": "road",
                    "elementType": "geometry",
                    "stylers": [
                    {
                        "color": "#f5f1e6"
                    }
                    ]
                },
                {
                    "featureType": "road.arterial",
                    "elementType": "geometry",
                    "stylers": [
                    {
                        "color": "#fdfcf8"
                    }
                    ]
                },
                {
                    "featureType": "road.highway",
                    "elementType": "geometry",
                    "stylers": [
                    {
                        "color": "#f8c967"
                    }
                    ]
                },
                {
                    "featureType": "road.highway",
                    "elementType": "geometry.stroke",
                    "stylers": [
                    {
                        "color": "#e9bc62"
                    }
                    ]
                },
                {
                    "featureType": "road.highway.controlled_access",
                    "elementType": "geometry",
                    "stylers": [
                    {
                        "color": "#e98d58"
                    }
                    ]
                },
                {
                    "featureType": "road.highway.controlled_access",
                    "elementType": "geometry.stroke",
                    "stylers": [
                    {
                        "color": "#db8555"
                    }
                    ]
                },
                {
                    "featureType": "road.local",
                    "elementType": "labels.text.fill",
                    "stylers": [
                    {
                        "color": "#806b63"
                    }
                    ]
                },
                {
                    "featureType": "transit.line",
                    "elementType": "geometry",
                    "stylers": [
                    {
                        "color": "#dfd2ae"
                    }
                    ]
                },
                {
                    "featureType": "transit.line",
                    "elementType": "labels.text.fill",
                    "stylers": [
                    {
                        "color": "#8f7d77"
                    }
                    ]
                },
                {
                    "featureType": "transit.line",
                    "elementType": "labels.text.stroke",
                    "stylers": [
                    {
                        "color": "#ebe3cd"
                    }
                    ]
                },
                {
                    "featureType": "transit.station",
                    "elementType": "geometry",
                    "stylers": [
                    {
                        "color": "#dfd2ae"
                    }
                    ]
                },
                {
                    "featureType": "water",
                    "elementType": "geometry.fill",
                    "stylers": [
                    {
                        "color": "#b9d3c2"
                    }
                    ]
                },
                {
                    "featureType": "water",
                    "elementType": "labels.text.fill",
                    "stylers": [
                    {
                        "color": "#92998d"
                    }
                    ]
                }
                ], {name: 'Styled'}
                );
map = new google.maps.Map(document.getElementById('map'), {
    zoom: 16,
    center: {lat: 10.768314000000016, lng: 106.70682110000007},
    mapTypeControl: true,
    mapTypeControlOptions: {
        style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
        mapTypeIds: ['roadmap', 'terrain', 'styled_map']
    }
});
map.mapTypes.set('styled_map', styledMapType);
map.setMapTypeId('styled_map');

var fileref=document.createElement('script')
fileref.setAttribute("type","text/javascript")
fileref.setAttribute("src", "/themes/askvietnamese/assets/js/geolocation-marker.js")

document.getElementsByTagName("head")[0].appendChild(fileref)

getMarkers(function(data){
    setMarkers(map,data);
})



}
button = document.getElementById("button")
button.onclick = function() {
    var startPos;
    var nudge = document.getElementById("nudge");

    var showNudgeBanner = function() {
        nudge.style.display = "block";
    };

    var hideNudgeBanner = function() {
        nudge.style.display = "none";
    };

    var nudgeTimeoutId = setTimeout(showNudgeBanner, 5000);

    var geoSuccess = function(position) {
        hideNudgeBanner();
                // We have the location, don't display banner
                clearTimeout(nudgeTimeoutId);

                // Do magic with location
                startPos = position;
                var latitude  = position.coords.latitude;
                var longitude = position.coords.longitude;
                var center = new google.maps.LatLng(latitude, longitude);
                map.panTo(center);
                var geoMarker = new GeolocationMarker(map);
                // document.getElementById('startLat').innerHTML = startPos.coords.latitude;
                // document.getElementById('startLon').innerHTML = startPos.coords.longitude;
            };
            var geoError = function(error) {
                switch(error.code) {
                    case error.TIMEOUT:
                        // The user didn't accept the callout
                        showNudgeBanner();
                        break;
                    }
                };

                navigator.geolocation.getCurrentPosition(geoSuccess, geoError);
            };

            $(document).ready(function(){   
                setTimeout(function () {
                    $("#nudge").fadeIn(200);
                }, 4000);
                $("#closeNudge, .nudgeOK").click(function() {
                    $("#nudge").fadeOut(200);
                }); 
            }); 

        </script>

        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD5ztk14jVCujAcpcVnD0lgS-0h1_1UdbU&callback=initMap"
        async defer></script>
